# Система Push-уведомлений

## Описание

Система уведомлений для VPN проекта, которая автоматически уведомляет пользователей о важных событиях, связанных с подписками и оплатами.

## Функционал

### 1. Запрос разрешений
- После успешной регистрации нового пользователя автоматически запрашивается разрешение на отправку push-уведомлений
- Для существующих пользователей разрешение запрашивается:
  - При входе в систему (через email/пароль или Google)
  - При автоматической загрузке пользователя при открытии приложения (с задержкой 2 секунды)
- Разрешение запрашивается только если его еще нет - система проверяет текущий статус перед запросом
- Разрешение запрашивается один раз, после чего сохраняется в браузере

### 2. Уведомления о подписках (об оплате тарифа)

Уведомления отправляются **два раза в день** (утром с 6:00 до 12:00 и вечером с 18:00 до 24:00), если:
- Подписка истекает в течение 7 дней или уже истекла
- Последнее уведомление было отправлено более 12 часов назад

#### Типы уведомлений:

**Подписка истекает в ближайшие 7 дней:**
- Заголовок: "Пора оплатить подписку"
- Текст: "Ваша подписка [название] скоро истечет. Оплатите тариф, чтобы продолжить пользоваться VPN без перерывов."
- Отправляется дважды в день (утром и вечером)

**Подписка истекает сегодня:**
- Заголовок: "Срочно: оплатите подписку"
- Текст: "Ваша подписка [название] истекает сегодня! Оплатите тариф сейчас, чтобы не потерять доступ к VPN."
- Отправляется дважды в день (утром и вечером)

**Подписка уже истекла:**
- Заголовок: "Подписка истекла - оплатите сейчас"
- Текст: "Ваша подписка [название] истекла. Оплатите тариф, чтобы восстановить доступ к VPN."
- Отправляется дважды в день (утром и вечером)

**Важно:** При клике на уведомление автоматически открывается модальное окно оплаты тарифа.

### 3. Уведомления об оплате

#### Успешная оплата
- Отправляется после успешного завершения платежа
- Текст: "Ваша подписка [название] успешно активирована. Сумма: [сумма] ₽."

#### Неуспешная оплата
- Отправляется при ошибке, отмене или отклонении платежа
- Текст: "Оплата не прошла: [причина]. Попробуйте еще раз или обратитесь в поддержку."

## Технические детали

### Структура файлов

```
src/
├── shared/
│   └── services/
│       └── notificationService.js          # Основной сервис уведомлений
└── features/
    ├── auth/
    │   └── hooks/
    │       └── useAuth.js                  # Запрос разрешений после регистрации
    └── dashboard/
        ├── components/
        │   └── Dashboard.jsx               # Интеграция уведомлений об оплате
        └── hooks/
            └── useSubscriptionNotifications.js  # Хук проверки подписок
```

### Компоненты

#### notificationService.js
Основной сервис для работы с браузерными push-уведомлениями:
- `requestPermission()` - запрос разрешения на уведомления
- `hasPermission()` - проверка наличия разрешения
- `showNotification(title, options)` - отправка уведомления
- Специализированные методы для каждого типа уведомлений

#### useSubscriptionNotifications.js
React хук для автоматической проверки подписок:
- Проверяет статус подписки каждые 30 минут
- Отправляет уведомления в нужное время
- Предотвращает дублирование уведомлений

### Интеграция

#### После регистрации
```javascript
// В useAuth.js и App.jsx
const notificationInstance = notificationService.getInstance()
await notificationInstance.requestPermission()
```

#### В Dashboard
```javascript
// Автоматическая проверка подписок
useSubscriptionNotifications(currentUser)

// Уведомления об оплате
await notificationInstance.notifyPaymentSuccess(tariffName, amount)
await notificationInstance.notifyPaymentFailed(reason)
```

## Настройка

### Браузерные требования
- Браузер должен поддерживать Web Notifications API
- Пользователь должен предоставить разрешение на уведомления
- Для работы в фоновом режиме рекомендуется использовать Service Worker (опционально)

### Иконки
По умолчанию используются:
- `icon`: `/favicon.ico`
- `badge`: `/favicon.ico`

Можно изменить в `notificationService.js` в методе `showNotification()`.

## Поведение уведомлений

- **Частота отправки**: Уведомления об оплате отправляются два раза в день (утром 6:00-12:00 и вечером 18:00-24:00)
- **Автозакрытие**: Уведомления об оплате не закрываются автоматически (требуют взаимодействия)
- **Клик по уведомлению**: 
  - Для уведомлений об оплате подписки - автоматически открывается модальное окно выбора тарифа для оплаты
  - Для других уведомлений - переход на страницу `/dashboard?tab=subscription`
- **Защита от дублирования**: Система предотвращает отправку уведомлений чаще, чем раз в 12 часов
- **Умное планирование**: Проверки запланированы на утреннее (6:00) и вечернее (18:00) время с дополнительной проверкой каждый час

## Логирование

Все действия системы уведомлений логируются через `logger`:
- Запрос разрешений
- Отправка уведомлений
- Ошибки при работе с уведомлениями

## Поддержка

Если уведомления не работают:
1. Проверьте разрешения браузера в настройках сайта
2. Убедитесь, что браузер поддерживает уведомления
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь, что сайт открыт по HTTPS (требование для уведомлений)
