# Система Push-уведомлений

## Описание

Система уведомлений для VPN проекта, которая автоматически уведомляет пользователей о важных событиях, связанных с подписками и оплатами.

## Функционал

### 1. Запрос разрешений
- После успешной регистрации нового пользователя автоматически запрашивается разрешение на отправку push-уведомлений
- Для существующих пользователей разрешение запрашивается:
  - При входе в систему (через email/пароль или Google)
  - При автоматической загрузке пользователя при открытии приложения (с задержкой 2 секунды)
- Разрешение запрашивается только если его еще нет - система проверяет текущий статус перед запросом
- Разрешение запрашивается один раз, после чего сохраняется в браузере

### 2. Уведомления о подписках

#### За 1 день до окончания
- Отправляется уведомление, когда до окончания подписки остается от 24 до 25 часов
- Текст: "Ваша подписка [название] истечет завтра ([дата]). Продлите подписку, чтобы продолжить пользоваться VPN."

#### В день окончания
- Отправляется уведомление, когда до окончания подписки остается менее 24 часов
- Текст: "Ваша подписка [название] истекает сегодня. Продлите подписку, чтобы не потерять доступ к VPN."

#### Когда подписка истекла
- Отправляется уведомление сразу после истечения срока подписки
- Текст: "Ваша подписка [название] истекла. Продлите подписку, чтобы восстановить доступ к VPN."

### 3. Уведомления об оплате

#### Успешная оплата
- Отправляется после успешного завершения платежа
- Текст: "Ваша подписка [название] успешно активирована. Сумма: [сумма] ₽."

#### Неуспешная оплата
- Отправляется при ошибке, отмене или отклонении платежа
- Текст: "Оплата не прошла: [причина]. Попробуйте еще раз или обратитесь в поддержку."

## Технические детали

### Структура файлов

```
src/
├── shared/
│   └── services/
│       └── notificationService.js          # Основной сервис уведомлений
└── features/
    ├── auth/
    │   └── hooks/
    │       └── useAuth.js                  # Запрос разрешений после регистрации
    └── dashboard/
        ├── components/
        │   └── Dashboard.jsx               # Интеграция уведомлений об оплате
        └── hooks/
            └── useSubscriptionNotifications.js  # Хук проверки подписок
```

### Компоненты

#### notificationService.js
Основной сервис для работы с браузерными push-уведомлениями:
- `requestPermission()` - запрос разрешения на уведомления
- `hasPermission()` - проверка наличия разрешения
- `showNotification(title, options)` - отправка уведомления
- Специализированные методы для каждого типа уведомлений

#### useSubscriptionNotifications.js
React хук для автоматической проверки подписок:
- Проверяет статус подписки каждые 30 минут
- Отправляет уведомления в нужное время
- Предотвращает дублирование уведомлений

### Интеграция

#### После регистрации
```javascript
// В useAuth.js и App.jsx
const notificationInstance = notificationService.getInstance()
await notificationInstance.requestPermission()
```

#### В Dashboard
```javascript
// Автоматическая проверка подписок
useSubscriptionNotifications(currentUser)

// Уведомления об оплате
await notificationInstance.notifyPaymentSuccess(tariffName, amount)
await notificationInstance.notifyPaymentFailed(reason)
```

## Настройка

### Браузерные требования
- Браузер должен поддерживать Web Notifications API
- Пользователь должен предоставить разрешение на уведомления
- Для работы в фоновом режиме рекомендуется использовать Service Worker (опционально)

### Иконки
По умолчанию используются:
- `icon`: `/favicon.ico`
- `badge`: `/favicon.ico`

Можно изменить в `notificationService.js` в методе `showNotification()`.

## Поведение уведомлений

- **Автозакрытие**: Уведомления автоматически закрываются через 5 секунд (кроме важных)
- **Клик по уведомлению**: Переход на страницу `/dashboard?tab=subscription`
- **Дублирование**: Система предотвращает отправку одинаковых уведомлений в течение определенного времени:
  - За 1 день: не чаще 1 раза в день
  - В день окончания: не чаще 1 раза в час
  - После истечения: не чаще 1 раза в день

## Логирование

Все действия системы уведомлений логируются через `logger`:
- Запрос разрешений
- Отправка уведомлений
- Ошибки при работе с уведомлениями

## Поддержка

Если уведомления не работают:
1. Проверьте разрешения браузера в настройках сайта
2. Убедитесь, что браузер поддерживает уведомления
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь, что сайт открыт по HTTPS (требование для уведомлений)
