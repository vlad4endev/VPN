#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ dev-—Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./update-server.sh

set -e

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
PROJECT_PATH="${1:-/opt/my-frontend}"

if [ ! -d "$PROJECT_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $PROJECT_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–ø—É—Ç—å_–∫_–ø—Ä–æ–µ–∫—Ç—É]"
    exit 1
fi

cd "$PROJECT_PATH"

echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
if [ ! -d ".git" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≠—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
    exit 1
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "üåø –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
echo ""

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "‚¨áÔ∏è  –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ GitHub..."
git fetch origin

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/$CURRENT_BRANCH)

if [ "$LOCAL" = "$REMOTE" ]; then
    echo "‚úÖ –ö–æ–¥ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω (–Ω–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤)"
else
    echo "üì• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º..."
    git pull origin $CURRENT_BRANCH
    echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω"
fi

echo ""

# –û—á–∏—â–∞–µ–º –∫–µ—à Vite
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Vite..."
rm -rf node_modules/.vite 2>/dev/null || true
rm -rf .vite 2>/dev/null || true
echo "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ dev-—Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ PM2
if command -v pm2 &> /dev/null; then
    PM2_PROCESS=$(pm2 list | grep -E "vpn|frontend|dev" | head -1 | awk '{print $2}' || echo "")
    if [ ! -z "$PM2_PROCESS" ]; then
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ PM2: $PM2_PROCESS"
        pm2 restart $PM2_PROCESS
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        echo ""
        echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2:"
        pm2 list
        exit 0
    fi
fi

# –ï—Å–ª–∏ PM2 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã node
echo "üîç –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ node/vite..."
NODE_PIDS=$(ps aux | grep -E "vite|node.*dev" | grep -v grep | awk '{print $2}' || echo "")

if [ ! -z "$NODE_PIDS" ]; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep -E "vite|node.*dev" | grep -v grep
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ dev-—Å–µ—Ä–≤–µ—Ä –≤—Ä—É—á–Ω—É—é (Ctrl+C) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run dev"
    echo ""
else
    echo "‚ÑπÔ∏è  Dev-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–µ dev-—Å–µ—Ä–≤–µ—Ä: npm run dev"
fi

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ï—Å–ª–∏ dev-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run dev"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, —á—Ç–æ –æ—à–∏–±–∫–∞ –∏—Å—á–µ–∑–ª–∞"
echo "   3. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+R –∏–ª–∏ Cmd+Shift+R)"
