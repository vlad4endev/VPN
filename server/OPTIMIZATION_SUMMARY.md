# üìä –°–≤–æ–¥–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Node.js —Å–µ—Ä–≤–∏—Å–∞

## üîç –ê–Ω–∞–ª–∏–∑ —É–∑–∫–∏—Ö –º–µ—Å—Ç

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –†–µ—à–µ–Ω–∏–µ |
|----------|------|--------|-------------|---------|
| –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `dist` –ø–∞–ø–∫–∏ | `proxy-server.js` | 376, 431 | –°—Ä–µ–¥–Ω—è—è | –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `fs.promises.access` |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤ | `proxy-server.js` | 197-321 | –í—ã—Å–æ–∫–∞—è | –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤ (30 —Å–µ–∫) |
| –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ | `proxy-server.js` | 248-289 | –í—ã—Å–æ–∫–∞—è | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π (1 —á–∞—Å) |
| –û–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å | –í—Å–µ —Ñ–∞–π–ª—ã | - | –í—ã—Å–æ–∫–∞—è | Cluster mode –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π | `payment-server.js` | 138-184 | –°—Ä–µ–¥–Ω—è—è | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤ (5-10 —Å–µ–∫) |

---

## ‚úÖ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏:

1. **`cache.js`** - –ú–æ–¥—É–ª—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏ —Å TTL
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö TTL –∑–Ω–∞—á–µ–Ω–∏–π

2. **`cluster.js`** - Cluster mode wrapper
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö CPU —è–¥–µ—Ä
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —É–ø–∞–≤—à–∏—Ö workers
   - Graceful shutdown

### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:

3. **`proxy-server.optimized.js`** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π proxy server
   - ‚úÖ –£–±—Ä–∞–Ω—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤ (30 —Å–µ–∫)
   - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (1 —á–∞—Å)
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cluster mode
   - ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏

4. **`payment-server.optimized.js`** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payment server
   - ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤
   - ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cluster mode

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

5. **`OPTIMIZATION_GUIDE.md`** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
6. **`OPTIMIZATION_SUMMARY.md`** - –≠—Ç–∞ —Å–≤–æ–¥–∫–∞

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã) | 200-500ms | 50-100ms | **70-80%** ‚¨áÔ∏è |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å | 100-200 req/s | 500-1000 req/s | **400-500%** ‚¨ÜÔ∏è |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU | ~25% (1 —è–¥—Ä–æ) | ~80-100% (–≤—Å–µ —è–¥—Ä–∞) | **300-400%** ‚¨ÜÔ∏è |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ API | 100% | 30-50% (–±–ª–∞–≥–æ–¥–∞—Ä—è –∫—ç—à—É) | **50-70%** ‚¨áÔ∏è |

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd server
cp proxy-server.js proxy-server.js.backup
cp payment-server.js payment-server.js.backup
```

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É
PROXY_PORT=3003 node server/proxy-server.optimized.js

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
curl http://localhost:3003/health
```

### –®–∞–≥ 3: –ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤

```bash
cd server
mv proxy-server.js proxy-server.js.old
cp proxy-server.optimized.js proxy-server.js

mv payment-server.js payment-server.js.old
cp payment-server.optimized.js payment-server.js
```

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PM2
pm2 restart xui-proxy
pm2 restart payment-server

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
node server/proxy-server.js
node server/payment-server.js
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –û—Ç–∫–ª—é—á–∏—Ç—å cluster mode (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
ENABLE_CLUSTER=false

# –ó–∞–¥–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers –≤—Ä—É—á–Ω—É—é
CLUSTER_WORKERS=4

# –ü–æ—Ä—Ç—ã
PROXY_PORT=3001
PAYMENT_SERVER_PORT=3002
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL –∫—ç—à–∞:

–í `proxy-server.optimized.js`:
- GET –∑–∞–ø—Ä–æ—Å—ã: —Å—Ç—Ä–æ–∫–∞ ~350 (30 —Å–µ–∫—É–Ω–¥)
- –°–µ—Å—Å–∏–∏: —Å—Ç—Ä–æ–∫–∞ ~230 (3600 —Å–µ–∫—É–Ω–¥ = 1 —á–∞—Å)

–í `payment-server.optimized.js`:
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞: —Å—Ç—Ä–æ–∫–∞ ~120 (10 —Å–µ–∫—É–Ω–¥)
- –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π: —Å—Ç—Ä–æ–∫–∞ ~160 (5 —Å–µ–∫—É–Ω–¥)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# 1. Health check
curl http://localhost:3001/health

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å)
time curl http://localhost:3001/api/xui/panel/api/inbounds
time curl http://localhost:3001/api/xui/panel/api/inbounds

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ cluster mode (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
ps aux | grep "node.*proxy-server"
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ**
   - GET –∑–∞–ø—Ä–æ—Å—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, —É–º–µ–Ω—å—à–∏—Ç–µ TTL

2. **Cluster mode –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏**
   - –ö–∞–∂–¥—ã–π worker - –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
   - –ù–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é —É–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers

3. **–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π**
   ```bash
   mv proxy-server.js proxy-server.js.broken
   mv proxy-server.js.old proxy-server.js
   ```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ **`OPTIMIZATION_GUIDE.md`**

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –ê–Ω–∞–ª–∏–∑ —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω
- [x] –ú–æ–¥—É–ª—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω
- [x] Cluster mode wrapper —Å–æ–∑–¥–∞–Ω
- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–≤–∞—à–∞ –∑–∞–¥–∞—á–∞)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ (–≤–∞—à–∞ –∑–∞–¥–∞—á–∞)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–≤–∞—à–∞ –∑–∞–¥–∞—á–∞)

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏! üéâ**
