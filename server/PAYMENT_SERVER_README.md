# üí≥ Payment Server - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π backend –¥–ª—è –ÆMoney

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Express —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –ÆMoney API –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä:
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –ÆMoney API (`request-payment`)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö (orderId, label, —Å—Ç–∞—Ç—É—Å) –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚úÖ –û—Ç–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
- ‚ö†Ô∏è **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã** - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç n8n —á–µ—Ä–µ–∑ `operation-history`

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
server/
‚îú‚îÄ‚îÄ payment-server.js    # Express —Å–µ—Ä–≤–µ—Ä (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
‚îú‚îÄ‚îÄ paymentService.js    # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ÆMoney API
‚îî‚îÄ‚îÄ storage.js           # –ú–æ–¥—É–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `server/` –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π:

```env
# –ÆMoney API
YOOMONEY_ACCESS_TOKEN=your_access_token_here
YOOMONEY_WALLET=410017383938322
YOOMONEY_CLIENT_ID=your_client_id_here  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
PAYMENT_SERVER_PORT=3002
PAYMENT_SERVER_HOST=0.0.0.0
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ –ÆMoney

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ [–ÆMoney Developer](https://yoomoney.ru/docs/wallet/using-api/intro)
2. –ü–æ–ª—É—á–∏—Ç–µ `client_id` –∏ `client_secret`
3. –ü–æ–ª—É—á–∏—Ç–µ `access_token` —á–µ—Ä–µ–∑ OAuth2 flow
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ `.env`

## üöÄ –ó–∞–ø—É—Å–∫

### Development —Ä–µ–∂–∏–º

```bash
cd server
npm run payment:dev
```

### Production —Ä–µ–∂–∏–º

```bash
cd server
npm run payment:start
```

### –° PM2

```bash
cd server
npm run payment:pm2
```

## üì° API Endpoints

### POST /create-payment

–°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –ÆMoney API.

**Request:**
```json
{
  "orderId": "order_1234567890",
  "amount": 150,
  "description": "–û–ø–ª–∞—Ç–∞ VPN –ø–æ–¥–ø–∏—Å–∫–∏",
  "userId": "user123",
  "tariffId": "tariff123"
}
```

**Response:**
```json
{
  "success": true,
  "orderId": "order_1234567890",
  "label": "order_1234567890",
  "requestId": "request_id_from_yoomoney",
  "paymentURL": "https://yoomoney.ru/...",
  "amount": 150,
  "status": "pending"
}
```

### GET /payment/:orderId

–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ.

**Response:**
```json
{
  "success": true,
  "payment": {
    "orderId": "order_1234567890",
    "label": "order_1234567890",
    "status": "pending",
    "amount": 150,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### GET /payments

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).

### GET /health

Health check endpoint.

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Backend —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂:**
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `POST /create-payment` —Å `orderId` –∏ `amount`
   - Backend —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –ÆMoney API
   - –í –∫–∞—á–µ—Å—Ç–≤–µ `label` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `orderId`
   - –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `paymentURL`

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç:**
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç `paymentURL` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–ª–∞—Ç—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ÆMoney

3. **n8n –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–ø–ª–∞—Ç—É:**
   - n8n –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç `operation-history` API –ÆMoney
   - –ò—â–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ `label` (–∫–æ—Ç–æ—Ä—ã–π = `orderId`)
   - –ü—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏:
     - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (—á–µ—Ä–µ–∑ API –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î)
     - –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - –°–æ–∑–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ 3x-ui

### –ü—Ä–∏–º–µ—Ä n8n workflow:

```
1. HTTP Request (GET) ‚Üí operation-history
   Query params:
   - label: {{ $json.orderId }}
   - type: "deposition"
   
2. IF ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞ –∏ status = "success"
   
3. HTTP Request (POST) ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   - –ò–ª–∏ –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Firestore
   
4. HTTP Request (POST) ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ 3x-ui
```

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
- **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:** –ó–∞–º–µ–Ω–∏—Ç–µ `storage.js` –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î:
  - PostgreSQL
  - MongoDB
  - Firestore
  - Redis

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ö†Ô∏è –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ `YOOMONEY_ACCESS_TOKEN` –≤ –∫–æ–¥–µ
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- ‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ rate limiting

### Label = orderId

- `label` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `operation-history`
- `label` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ `label = orderId` –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

```bash
curl -X POST http://localhost:3002/create-payment \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "order_test_123",
    "amount": 150,
    "description": "–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂",
    "userId": "user123",
    "tariffId": "tariff123"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

```bash
curl http://localhost:3002/payment/order_test_123
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏

–°–µ—Ä–≤–µ—Ä –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:
- `üí≥ Creating payment` - –Ω–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- `üì§ Request to YooMoney API` - –∑–∞–ø—Ä–æ—Å –∫ API
- `‚úÖ Payment created` - —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
- `‚ùå Error` - –æ—à–∏–±–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆMoney API](https://yoomoney.ru/docs/wallet/using-api/request-payment)
- [operation-history API](https://yoomoney.ru/docs/wallet/using-api/operation-history)

## üö® Troubleshooting

### –û—à–∏–±–∫–∞: "YOOMONEY_ACCESS_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.env` —Ñ–∞–π–ª.

### –û—à–∏–±–∫–∞: "–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ÆMoney API"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ API

### –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ë–î.
