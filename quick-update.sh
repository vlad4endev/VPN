#!/bin/bash

###############################################################################
# –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
# 1. –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub (–≤–µ—Ç–∫–∞ main)
# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç frontend –∏ backend
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   chmod +x quick-update.sh
#   ./quick-update.sh
###############################################################################

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

log "üîÑ –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    log_error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º!"
    exit 1
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
log_info "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    log_warning "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    log_info "–°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    git stash push -m "Auto-stash before update $(date +'%Y-%m-%d %H:%M:%S')" || true
fi

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
log "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub..."
git fetch origin $CURRENT_BRANCH || {
    log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub"
    log_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ remote: git remote -v"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/$CURRENT_BRANCH)

if [ "$LOCAL" = "$REMOTE" ]; then
    log_success "–ö–æ–¥ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω (–Ω–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤)"
else
    log_info "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º..."
    git pull origin $CURRENT_BRANCH
    log_success "–ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω —Å GitHub"
fi

echo ""

# –û—á–∏—â–∞–µ–º –∫–µ—à Vite
log "üßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Vite..."
rm -rf node_modules/.vite 2>/dev/null || true
rm -rf .vite 2>/dev/null || true
log_success "–ö–µ—à –æ—á–∏—â–µ–Ω"

echo ""

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
log "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º stop-all.sh –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f "stop-all.sh" ]; then
    ./stop-all.sh > /dev/null 2>&1 || true
    sleep 2
fi

log_success "–ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo ""

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—ã
log "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º start-all.sh –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f "start-all.sh" ]; then
    ./start-all.sh
    log_success "–°–ª—É–∂–±—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"
else
    log_warning "–°–∫—Ä–∏–ø—Ç start-all.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
    log_info "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—ã –≤—Ä—É—á–Ω—É—é: npm run dev"
fi

echo ""
log_success "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
log_info "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ${GREEN}tail -f backend.log${NC}    # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ backend"
echo "  ${GREEN}tail -f frontend.log${NC}   # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ frontend"
echo "  ${GREEN}./stop-all.sh${NC}          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–ª—É–∂–±—ã"
echo ""
