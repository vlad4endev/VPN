version: '3.8'

services:
  skyputh-vpn:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: skyputh-vpn
    ports:
      - "3001:3001"
    environment:
      # Общие настройки
      - NODE_ENV=production
      - PROXY_PORT=3001
      - PROXY_HOST=0.0.0.0
      
      # Backend proxy настройки
      - XUI_HOST=${XUI_HOST:-http://localhost:2053}
      - XUI_USERNAME=${XUI_USERNAME:-admin}
      - XUI_PASSWORD=${XUI_PASSWORD}
      - XUI_INBOUND_ID=${XUI_INBOUND_ID:-1}
      
      # CORS настройки
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3001,https://yourdomain.com}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3001}
    
    # Используем .env файл (НЕ копируется в образ!)
    env_file:
      - .env.production
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # Restart policy
    restart: unless-stopped
    
    # Security: непривилегированный пользователь (уже в образе)
    user: "1001:1001"
    
    # Networks (опционально)
    networks:
      - vpn-network

networks:
  vpn-network:
    driver: bridge
